name: Azure Pipelines

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
trigger:
- main

# ToDo: Replace the agent pool name, if you are using Udacity Cloud lab. 
# Otherwise, comment out the line below. 
#pool: myAgentPool

variables:
  python.version: '3.7.6'
  # ToDo: Replace the service connection name as used in the DevOps project settings
  azureServiceConnectionId: 'b1387354-0240-4d1a-b331-e8043b91cc6c' # DONE
  # Project root folder. Point to the folder containing manage.py file.
  projectRoot: $(System.DefaultWorkingDirectory)
  # Environment name
  environmentName: 'my-env'

stages:
  - stage: PipelineTest
    jobs:
      - job: Randomtest
        steps:
        - task: CmdLine@2
          inputs:
            script: 'echo Hello world'
  
  - stage: InfraStandUp
    jobs:
      - job: BuildInfrastructure
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          - task: TerraformTaskV4@4
            displayName: 'Initialize Terraform - terraform init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
              backendServiceArm: 'Training-Sub-01 (601c9c7b-8f40-476f-92b1-3b437e0aef1d)'
              backendAzureRmResourceGroupName: 'Azuredevops'
              backendAzureRmStorageAccountName: 'tfstate2377230974'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'test.terraform.tfstate'
              
          - task: TerraformTaskV4@4
            displayName: 'Validate code - terraform validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'

          # - task: TerraformTaskV4@4
          #   displayName: 'Plan output - terraform plan'
          #   inputs:
          #     provider: 'azurerm'
          #     command: 'plan'
          #     workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/environments/test'
          #     environmentServiceNameAzureRM: 'Training-Sub-01 (601c9c7b-8f40-476f-92b1-3b437e0aef1d)'
              
          # - task: TerraformTaskV4@4
          #   displayName: 'Apply configuration - terraform apply'
          #   inputs:
          #     provider: 'azurerm'
          #     command: 'apply'
          #     environmentServiceNameAzureRM: 'Training-Sub-01 (601c9c7b-8f40-476f-92b1-3b437e0aef1d)'

  - stage: ToolsProvisioning
    jobs:
      - job: TestingToolSetup
        steps:
          - task: CmdLine@2
            displayName: 'Install node'
            inputs:
              script: 'sudo apt install nodejs'
              
          - task: CmdLine@2
            displayName: 'Ensure node is installed'
            inputs:
              script: 'nodejs --version'

          - task: CmdLine@2
            displayName: 'Install newman'
            inputs:
              script: 'npm install -g newman'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
              
              
          - task: CmdLine@2
            displayName: 'Ensure newman is installed'
            inputs:
              script: 'newman -v'

          # - task: CmdLine@2
          #   displayName: 'Run Regression tests'
          #   continueOnError: true
          #   inputs:
          #     script: 'newman run regression_Postman.postman_collection.json -e Regression_env.postman_environment.json --reporters cli,junit --reporter-junit-export TestPostMan\PostmanRegression.xml'
          #     workingDirectory: '$(System.DefaultWorkingDirectory)'

          - task: CmdLine@2
            displayName: 'ls -la'
            continueOnError: true
            inputs:
              script: 'ls -la'
              workingDirectory: '$(System.DefaultWorkingDirectory)/automatedtesting'